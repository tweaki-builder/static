name: Clone Websites Locally

on:
  workflow_dispatch:
  push:
    paths:
      - "clone-urls/*.json"

permissions:
  contents: write

jobs:
  clone:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y jq httrack

      - name: Clone websites
        run: |
          set -e

          for file in clone-urls/*.json; do
            echo "üöÄ Processing $file"

            URL=$(jq -r '.url' "$file")
            SAFE_NAME=$(basename "$file" .json)
            OUTPUT_DIR="sites/$SAFE_NAME"

            echo "‚û°Ô∏è Cloning: $URL"
            mkdir -p "$OUTPUT_DIR"

            httrack "$URL" \
              -O "$OUTPUT_DIR" \
              "+*.css" "+*.js" "+*.png" "+*.jpg" "+*.jpeg" "+*.gif" "+*.svg" \
              "+*.woff" "+*.woff2" "+*.ttf" "+*.eot" \
              -v \
              --disable-security-limits \
              --robots=0 \
              --keep-alive \
              --sockets=4 \
              --depth=5 \
              --mirror \
              --update

            echo "‚úÖ Done: $URL"
          done

      - name: Commit cloned sites
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add sites/
          git commit -m "Clone websites from JSON configs" || echo "Nothing to commit"
          git push
