;
(self.AMP=self.AMP||[]).push({m:1,v:"2510081644000",n:"amp-web-push",ev:"0.1",l:!0,f:function(t,e){(()=>{var{isArray:e}=Array,{hasOwnProperty:i,toString:s}=Object.prototype;function r(t){const e=Object.create(null);return t&&Object.assign(e,t),e}function n(t){return CSS.escape(t)}var o=/(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;function u(t,e=""){try{return decodeURIComponent(t)}catch(t){return e}}function h(t){const e=r();if(!t)return e;let i;for(;i=o.exec(t);){const t=u(i[1],i[1]),s=i[2]?u(i[2].replace(/\+/g," "),i[2]):"";e[t]=s}return e}self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var l=self.__AMP_LOG;function c(t,e){throw new Error("failed to call initLogConstructor")}function a(t){return l.user||(l.user=p()),function(t,e){return e&&e.ownerDocument.defaultView!=t}(l.user.win,t)?l.userForEmbed||(l.userForEmbed=p()):l.user}function p(t){return c()}function d(t,e,i,s,r,n,o,u,h,l,c){return t}var f="amp-web-push",m=f,w=f+"-service",_=f+"-widget",b="granted",P="denied",v="default";function g(t,e){d(function(t,e){const i=t.__AMP_SERVICES&&t.__AMP_SERVICES[e];return!(!i||!i.ctor)}(t,e));const i=A(t)[e];return i.obj||(d(i.ctor),d(i.context),i.obj=new i.ctor(i.context),d(i.obj),i.context=null,i.resolve&&i.resolve(i.obj)),i.obj}function A(t){let e=t.__AMP_SERVICES;return e||(e=t.__AMP_SERVICES={}),e}var R,E,I=class extends t.BaseElement{constructor(t){super(t)}isLayoutSupported(t){return"fixed"==t}buildCallback(){this.element.classList.add("amp-invisible")}},y="subscribed",M="unsubscribed",T="blocked";function S(t){return t.data}function V(t,e,i,s){let r=i;const n=function(t,e,i,s){let r=t,n=i,o=t=>{try{return n(t)}catch(t){var e,i;throw null===(e=(i=self).__AMP_REPORT_ERROR)||void 0===e||e.call(i,t),t}};const u=function(){if(void 0!==R)return R;R=!1;try{const t={get capture(){return R=!0,!1}};self.addEventListener("test-options",null,t),self.removeEventListener("test-options",null,t)}catch(t){}return R}(),h=!(null==s||!s.capture);return r.addEventListener(e,o,u?s:h),()=>{null==r||r.removeEventListener(e,o,u?s:h),n=null,r=null,o=null}}(t,e,(t=>{try{r(t)}finally{r=null,n()}}),s);return n}function k(t){return"AUDIO"===t.tagName||"VIDEO"===t.tagName}function O(t,e){return E||(E=self.document.createElement("a")),function(t,e,i){return t.href="",new URL(e,t.href)}(E,t)}var C=class t{constructor(t){t||(t={debug:!1,windowContext:window}),this.gt={},this.te={},this.ee=t.debug,this.ne=!1,this.re=!1,this.ie=!1,this.se=null,this.oe=null,this.ce=null,this.ue=null,this.le=null,this.he=t.windowContext||window}listen(e){return new Promise(((t,i)=>{this.ie?i(new Error("Already connected.")):this.ne?i(new Error("Already listening for connections.")):Array.isArray(e)?(this.ce=this.ae.bind(this,e,t,i),this.he.addEventListener("message",this.ce),this.ee):i(new Error("allowedOrigins should be a string array of allowed origins to accept messages from. Got:",e))})).then((()=>{this.send(t.Topics.CONNECT_HANDSHAKE,null),this.ie=!0}))}fe(t,e){const i=O(t).origin;for(let t=0;t<e.length;t++)if(O(e[t]).origin===i)return!0;return!1}ae(e,i,s,r){const n=S(r),{origin:o,ports:u}=r;this.ee,this.fe(o,e)&&n&&n.topic===t.Topics.CONNECT_HANDSHAKE&&(this.he.removeEventListener("message",this.ce),this.oe=u[0],this.le=this.de.bind(this),this.oe.addEventListener("message",this.le,!1),this.oe.start(),i())}connect(e,i){return new Promise(((s,r)=>{e||r(new Error("Provide a valid Window context to connect to.")),i||r(new Error("Provide an expected origin for the remote Window or provide the wildcard *.")),this.ie?r(new Error("Already connected.")):this.re?r(new Error("Already connecting.")):(this.se=new MessageChannel,this.oe=this.se.port1,this.ue=this.ge.bind(this,this.oe,i,s),this.oe.addEventListener("message",this.ue),this.oe.start(),e.postMessage({topic:t.Topics.CONNECT_HANDSHAKE},"*"===i?"*":O(i).origin,[this.se.port2]))}))}ge(t,e,i){this.ie=!0,this.ee,t.removeEventListener("message",this.ue),this.le=this.de.bind(this),t.addEventListener("message",this.le,!1),i()}static get Topics(){return{CONNECT_HANDSHAKE:"topic-connect-handshake",NOTIFICATION_PERMISSION_STATE:"topic-notification-permission-state",SERVICE_WORKER_STATE:"topic-service-worker-state",SERVICE_WORKER_REGISTRATION:"topic-service-worker-registration",SERVICE_WORKER_QUERY:"topic-service-worker-query",STORAGE_GET:"topic-storage-get"}}de(t){const e=S(t);if(this.gt[e.id]&&e.isReply){const t=this.gt[e.id];delete this.gt[e.id];const{promiseResolver:i}=t;t.message=e.data,this.ee,i([e.data,this.pe.bind(this,e.id,t.topic)])}else{const t=this.te[e.topic];if(!t)return;this.ee;for(let i=0;i<t.length;i++)(0,t[i])(e.data,this.pe.bind(this,e.id,e.topic))}}on(t,e){this.te[t]?this.te[t].push(e):this.te[t]=[e]}off(t,e){if(e){const i=this.te[t].indexOf(e);-1!==i&&this.te[t].splice(i,1)}else this.te[t]&&delete this.te[t]}pe(t,e,i){const s={id:t,topic:e,data:i,isReply:!0};return this.oe.postMessage(s),new Promise((t=>{this.gt[s.id]={message:i,topic:e,promiseResolver:t}}))}send(t,e){const i={id:crypto.getRandomValues(new Uint8Array(10)).join(""),topic:t,data:e};return this.ee,this.oe.postMessage(i),new Promise((s=>{this.gt[i.id]={message:e,topic:t,promiseResolver:s}}))}},U="amp-web-push-widget.amp-invisible{visibility:hidden}\n/*# sourceURL=/extensions/amp-web-push/0.1/amp-web-push.css*/";function $(t,e,i){if(e[i])return e[i];const s=t.querySelector(`style[${i}], link[${i}]`);return s?(e[i]=s,s):null}function W(t,e){const i=t.styleSheets;for(let t=0;t<i.length;t++)if(i[t].ownerNode==e)return!0;return!1}function F(t){return e=w,function(t,e){const i=function(t,e){const i=A(t)[e];return i?i.promise?i.promise:(g(t,e),i.promise=Promise.resolve(i.obj)):null}(t,e);if(i)return i;const s=A(t);return s[e]=function(){const t=new class{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}},{promise:e,reject:i,resolve:s}=t;return e.catch((()=>{})),{obj:null,promise:e,resolve:s,reject:i,context:null,ctor:null}}(),s[e].promise}(function(t){const e=function(t){return t.nodeType?(i=t,e=(i.ownerDocument||i).defaultView,function(t,e){return g(t=function(t){return t.__AMP_TOP||(t.__AMP_TOP=t)}(t),"ampdoc")}(e)).getAmpDoc(t):t;var e,i}(t);return e.isSingleDoc()?e.win:e}(t),e);var e}var x={HELPER_FRAME_URL:"helper-iframe-url",PERMISSION_DIALOG_URL:"permission-dialog-url",SERVICE_WORKER_URL:"service-worker-url",SERVICE_WORKER_SCOPE:"service-worker-scope"},L=class extends t.BaseElement{constructor(t){super(t)}validate(){this.tut(),this.eut();const t={"helper-iframe-url":null,"permission-dialog-url":null,"service-worker-url":null,"service-worker-scope":null};for(const s in x){const r=x[s];e=this.element.getAttribute(r)||"service-worker-scope"===r,i=`The ${r} attribute is required for <amp-web-push>`,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,a().assert(e,i,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined),t[r]=this.element.getAttribute(r)}var e,i;if(!this.iut(t["helper-iframe-url"]))throw a().createError("<amp-web-push> must have a valid helper-iframe-url attribute. It should begin with the https:// protocol and point to the provided lightweight template page provided for AMP messaging.");if(!this.iut(t["permission-dialog-url"]))throw a().createError("<amp-web-push> must have a valid permission-dialog-url attribute. It should begin with the https:// protocol and point to the provided template page for showing the permission prompt.");if("https:"!==O(t["service-worker-url"]).protocol)throw a().createError("<amp-web-push> must have a valid service-worker-url attribute. It should begin with the https:// protocol and point to the service worker JavaScript file to be installed.");if(O(t["service-worker-url"]).origin!==O(t["permission-dialog-url"]).origin||O(t["permission-dialog-url"]).origin!==O(t["helper-iframe-url"]).origin)throw a().createError("<amp-web-push> URL attributes service-worker-url, permission-dialog-url, and helper-iframe-url must all share the same origin.")}parseConfig(){const t={};for(const e in x){const i=x[e];t[i]=this.element.getAttribute(i)}return t}buildCallback(){this.validate();const t=this.parseConfig();F(this.element).then((e=>{e.start(t).catch((()=>{}))})),this.registerAction("subscribe",this.sut.bind(this)),this.registerAction("unsubscribe",this.rut.bind(this))}tut(){if(this.element.getAttribute("id")!==f)throw a().createError("<amp-web-push> must have an id attribute with value '"+f+"'.")}eut(){if(this.getAmpDoc().getRootNode().querySelectorAll(`#${n(m)}`).length>1)throw a().createError("Only one <amp-web-push> element may exist on a page.")}sut(t){const e=t.event.target;this.nut(e,!0),F(this.element).then((t=>{t.subscribe((()=>{this.nut(e,!1)})).then((()=>{this.nut(e,!1)}))}))}nut(t,e){t.disabled=e}rut(t){const e=t.event.target;this.nut(e,!0),F(this.element).then((t=>{t.unsubscribe().then((()=>{this.nut(e,!1)}))}))}iut(t){try{const e=O(t),i=e.pathname.length>1;return"https:"===e.protocol&&i}catch(t){return!1}}};t.registerServiceForDoc(w,class t{static get PERMISSION_POPUP_URL_FRAGMENT(){return"amp-web-push-subscribing=yes"}static get AMP_VERSION_INITIAL(){return 1}constructor(t){this.ampdoc=t,function(t,e,i,s,n){const o=t.getHeadNode(),u=function(t,e,i,s){let n=t.__AMP_CSS_SM;n||(n=t.__AMP_CSS_SM=r());const o=`amp-extension=${s}`;if(o){const i=$(t,n,o);if(i)return"STYLE"==i.tagName&&i.textContent!==e&&(i.textContent=e),i}const u=(t.ownerDocument||t).createElement("style");u.textContent=e;let h=null;return u.setAttribute("amp-extension",s),h=$(t,n,"amp-runtime"),function(t,e,i=null){if(!i)return void function(t,e){t.insertBefore(e,t.firstChild)}(t,e);const s=i.nextSibling;t.insertBefore(e,s)}(t,u,h),o&&(n[o]=u),u}(o,function(t,e){const i=t.__AMP_CSS_TR;return i?i(e):e}(o,"amp-web-push-widget.amp-invisible{visibility:hidden}\n/*# sourceURL=/extensions/amp-web-push/0.1/amp-web-push.css*/"),0,"amp-web-push");if(i){const e=t.getRootNode();if(W(e,u))return u;const i=setInterval((()=>{W(e,u)&&clearInterval(i)}),4)}}(t,0,(()=>{})),this.nA={"helper-iframe-url":null,"permission-dialog-url":null,"service-worker-url":null,debug:null},this.ee=!1,this.eb=null,this.out=null,this.uut=new C({debug:this.ee}),this.hut=null}start(t){if(!this.environmentSupportsWebPush())return Promise.reject("Web push is not supported");this.initializeConfig(t);const e=this.installHelperFrame();return e.then((()=>this.uut.connect(this.eb.getDomElement().contentWindow,O(this.nA["helper-iframe-url"]).origin))).then((()=>{if(!this.isContinuingSubscriptionFromRedirect())return this.updateWidgetVisibilities();this.lut()})),e}initializeConfig(t){this.nA=t,this.nA}installHelperFrame(){const t=-1!==this.nA["helper-iframe-url"].indexOf("?")?"&":"?",e=`${this.nA["helper-iframe-url"]}${t}parentOrigin=${this.ampdoc.win.location.origin}`;return this.eb=new class{constructor(t,e){this.zi=t,this.mi=e,this.cut=null,this.Ui=new Promise((()=>{}))}load(){return this.zi.whenReady().then((()=>{var t,e;return this.cut=this.zi.win.document.createElement("iframe"),t=this.cut,void 0===(e=!1)&&(e=t.hasAttribute("hidden")),e?t.removeAttribute("hidden"):t.setAttribute("hidden",""),this.cut.sandbox="allow-same-origin allow-scripts",this.cut.src=this.mi,this.zi.getBody().appendChild(this.cut),this.Ui=function(t){let e,i;if(function(t){return!!(t.complete||"complete"==t.readyState||k(t)&&t.readyState>0||t.document&&"complete"==t.document.readyState)}(t))return Promise.resolve(t);const s=k(t);return s&&t.__AMP_MEDIA_LOAD_FAILURE_SRC===t.currentSrc?Promise.reject(t):new Promise(((r,n)=>{if(e=s?V(t,"loadedmetadata",r,{capture:!0}):V(t,"load",r),!t.tagName)return;let o=t;if(s&&!t.hasAttribute("src")&&(o=function(t,e){for(let i=t.lastElementChild;i;i=i.previousElementSibling)if(e(i))return i;return null}(t,(t=>"SOURCE"===t.tagName)),!o))return n(new Error("Media has no source."));i=V(o,"error",n)})).then((()=>(i&&i(),t)),(()=>{e&&e(),function(t){k(t)&&(t.__AMP_MEDIA_LOAD_FAILURE_SRC=t.currentSrc||!0);let e=t;throw e&&e.src&&(e=e.src),a().createError("Failed to load:",e)}(t)}))}(this.cut),this.whenReady()}))}getDomElement(){return this.cut}whenReady(){return this.Ui}}(this.ampdoc,e),this.eb.load()}isContinuingSubscriptionFromRedirect(){return-1!==(this.ampdoc.win.testLocation||this.ampdoc.win.location).search.indexOf(t.PERMISSION_POPUP_URL_FRAGMENT)}removePermissionPopupUrlFragmentFromUrl(e){let i=e.replace(`?${t.PERMISSION_POPUP_URL_FRAGMENT}`,"");return i=i.replace(`&${t.PERMISSION_POPUP_URL_FRAGMENT}`,""),i}aut(t,e){return this.eb.whenReady().then((()=>this.uut.send(t,e))).then((i=>{const s=i[0];if(s.success)return s.result;throw new Error(`AMP page helper iframe query topic ${t} and message ${e} failed with: ${s.error}`)}))}dut(t,e){return this.aut(C.Topics.SERVICE_WORKER_QUERY,{topic:t,payload:e})}queryNotificationPermission(){return this.aut(C.Topics.NOTIFICATION_PERMISSION_STATE,null)}fut(){return this.aut(C.Topics.SERVICE_WORKER_STATE,null)}registerServiceWorker(){const t=this.nA["service-worker-url"],e=this.nA["service-worker-scope"];return this.aut(C.Topics.SERVICE_WORKER_REGISTRATION,{workerUrl:t,registrationOptions:e?{scope:e}:{}})}querySubscriptionStateRemotely(){return this.dut("amp-web-push-subscription-state",null)}subscribeForPushRemotely(){return this.dut("amp-web-push-subscribe",null)}unsubscribeFromPushRemotely(){return this.dut("amp-web-push-unsubscribe",null)}isServiceWorkerActivated(){const t=this;return this.fut().then((e=>{const i=!0===e.isControllingFrame,s=this.isUrlSimilarForQueryParams(e.url,t.nA["service-worker-url"]),r="activated"===e.state;return i&&s&&r}))}isUrlSimilarForQueryParams(t,e){const i=O(t),s=h(i.search),r=O(e),n=h(r.search);for(const t in s)if(n[t]!==s[t])return!1;return i.origin===r.origin&&i.pathname===r.pathname}setWidgetVisibilities(t,e){const i=this.ampdoc.getRootNode().querySelectorAll(`${n(_)}[visibility=${n(t)}]`),s="amp-invisible";for(let t=0;t<i.length;t++){const r=i[t];e?r.classList.remove(s):r.classList.add(s)}}mut(t){return this.ampdoc.getRootNode().querySelectorAll(`${n(_)}[visibility=${n(t)}]`).length>0}wut(t){if("boolean"==typeof t)return 1}_ut(){return this.queryNotificationPermission().then((t=>{this.out=t}))}updateWidgetVisibilities(){return this._ut().then((()=>this.but(C.Topics.STORAGE_GET))).then((t=>!0===t?this.Put("amp-web-push-notification-permission"):Promise.resolve(v))).then((t=>{if(t!==P)return this.isServiceWorkerActivated().then((t=>{t?this.vut():this.gut()}));this.mut(T)?this.Aut():this.gut()}))}vut(){return(e=this.ampdoc.win,g(e,"timer")).timeoutPromise(5e3,this.querySubscriptionStateRemotely().then((e=>{if(this.wut(e)!==t.AMP_VERSION_INITIAL)throw a().createError("The controlling service worker replied to amp-web-push with an unexpected value.");e?(this.setWidgetVisibilities(M,!1),this.setWidgetVisibilities(y,!0),this.setWidgetVisibilities(T,!1)):this.gut()})),"The controlling service worker does not support amp-web-push.");var e}gut(){this.setWidgetVisibilities(M,!0),this.setWidgetVisibilities(y,!1),this.setWidgetVisibilities(T,!1)}Aut(){this.setWidgetVisibilities(M,!1),this.setWidgetVisibilities(y,!1),this.setWidgetVisibilities(T,!0)}subscribe(t){const e=[];return e.push(this.registerServiceWorker()),e.push(new Promise((e=>{if(this.out===b)return this.Rut().then((()=>{e()}));{const i=this.openPopupOrRedirect();this.Eut(i,t),this.hut=new C({debug:this.ee}),this.hut.listen([this.nA["permission-dialog-url"]]),this.onPermissionDialogInteracted().then((t=>this.handlePermissionDialogInteraction(t))).then((()=>{e()}))}}))),Promise.all(e)}Eut(t,e){if(t&&!t.closed){const i=this.ampdoc.win.setInterval((()=>{t.closed&&(e(),this.ampdoc.win.clearInterval(i))}),500)}}handlePermissionDialogInteraction(t){const e=t[0],i=t[1];switch(e){case P:case v:return i({closeFrame:!0}),this.updateWidgetVisibilities();case b:i({closeFrame:!0}),this.Rut();break;default:throw new Error("Unexpected permission value:",e)}}Rut(){return this.subscribeForPushRemotely().then((()=>this.updateWidgetVisibilities()))}unsubscribe(){return this.unsubscribeFromPushRemotely().then((()=>this.updateWidgetVisibilities()))}but(t){return this.aut(C.Topics.NOTIFICATION_PERMISSION_STATE,{isQueryTopicSupported:t})}Put(t){return this.aut(C.Topics.STORAGE_GET,{key:t})}onPermissionDialogInteracted(){return new Promise((t=>{this.hut.on(C.Topics.NOTIFICATION_PERMISSION_STATE,((e,i)=>{t([e,i])}))}))}static Iut(){const t=Math.floor(Math.min(700,.9*screen.width)),e=Math.floor(Math.min(450,.9*screen.height));return{w:t,h:e,x:Math.floor((screen.width-t)/2),y:Math.floor((screen.height-e)/2)}}openPopupOrRedirect(){const e=-1!==this.ampdoc.win.location.href.indexOf("?")?"&":"?",i=this.ampdoc.win.location.href+e+t.PERMISSION_POPUP_URL_FRAGMENT,s=-1!==this.nA["permission-dialog-url"].indexOf("?")?"&":"?",r=this.nA["permission-dialog-url"]+s+`return=${encodeURIComponent(i)}`,n=t.Iut(),o=`height=${n.h},width=${n.w},left=${n.x},top=${n.y},resizable=yes,scrollbars=yes`;return function(t,e,i,s){let r;try{r=t.open(e,i,s)}catch(t){(l.dev||(l.dev=c())).error("DOM","Failed to open url on target: ",i,t)}var n,o;return!r&&("number"!=typeof o&&(o=0),o+"noopener".length>(n=s||"").length||-1===n.indexOf("noopener",o))&&(r=t.open(e,"_top")),r}(this.ampdoc.win,r,"_blank",o)}lut(){this.ampdoc.win.history.replaceState(null,"",this.removePermissionPopupUrlFragmentFromUrl(this.ampdoc.win.location.href)),this.queryNotificationPermission().then((t=>{switch(t){case P:case v:return this.updateWidgetVisibilities();case b:this.Rut();break;default:throw new Error("Unexpected permission value",t)}}))}environmentSupportsWebPush(){return this.yut()&&this.Mut()}yut(){return void 0!==this.ampdoc.win.Notification&&void 0!==this.ampdoc.win.navigator.serviceWorker&&void 0!==this.ampdoc.win.PushManager}Mut(){return"https:"===this.ampdoc.win.location.protocol||"localhost"===this.ampdoc.win.location.hostname||"127.0.0.1"===this.ampdoc.win.location.hostname||!1}}),t.registerElement(m,L),t.registerElement(_,I,U)})();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */}});
//# sourceMappingURL=amp-web-push-0.1.mjs.map